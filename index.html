<!DOCTYPE html>
<html lang="en"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Percentage Calculator</title> 

    <!-- PWA: Link to the Web App Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- PWA: Set theme color for browser UI -->
    <meta name="theme-color" content="#2D2D2D">

    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* Basic Reset & General Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: #2D2D2D;
            color: #EAEAEA;
            line-height: 1.5;
            padding: 10px;
            /* Disable Text Selection */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .container {
            max-width: 650px;
            margin: 0 auto;
            width: 100%;
        }

        /* Header */
        header {
            margin-bottom: 20px;
            display: flex;
            align-items: center; /* Vertically align items */
            gap: 10px;
            flex-wrap: wrap;
            position: relative; /* To position settings button */
        }

        .logo-img {
            display: block;
            width: 36px;
            height: 36px;
            flex-shrink: 0;
        }

        h1 {
            font-size: 1.6em;
            margin-bottom: 0;
            font-weight: 600;
            flex-grow: 1;
        }

        /* Generic Icon Button Style (Settings) */
        .icon-btn {
            background: none;
            border: none;
            color: #AAAAAA;
            font-size: 1.3em;
            padding: 5px;
            line-height: 1;
            cursor: pointer;
            margin-left: auto; /* Push to the right */
            outline: none;
             box-shadow: none;
             -webkit-tap-highlight-color: transparent;
        }
         .icon-btn:hover, .icon-btn:focus {
             color: #CCCCCC;
             outline: none !important;
             box-shadow: none !important;
             background: none !important;
             border: none !important;
         }

        /* Calculator Section */
        .calculator-section {
            background-color: #3A3A3A;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 6px;
            border: none; /* Default border removed */
            border-left: 1px solid transparent; /* Reserve space for highlight */
            overflow: hidden;
            position: relative;
            transition: border-left-color 0.2s ease-in-out; /* Target left border */
        }

        /* Active Section Highlight */
        .calculator-section.active-section {
             border-left: 1px solid #F2A122; /* UPDATED ORANGE left border */
        }

        /* Hidden Section Style */
        .calculator-section.hidden-section {
            display: none;
        }


        /* Clear Button Styling */
        .clear-section-btn {
            position: absolute;
            top: 8px;
            right: 10px;
            background: none;
            border: none;
            color: #AAAAAA;
            font-size: 1.5em;
            font-weight: bold;
            line-height: 1;
            padding: 0 4px;
            cursor: pointer;
            outline: none;
            box-shadow: none;
            -webkit-tap-highlight-color: transparent;
            z-index: 2;
            display: none; /* Hide by default - JS will show it */
        }
         .clear-section-btn:focus,
         .clear-section-btn:active,
         .clear-section-btn:hover {
             outline: none !important;
             box-shadow: none !important;
             background: none !important;
             color: #AAAAAA !important;
             border: none !important;
         }

        /* Section Description Styling */
        .section-description {
            font-size: 0.85em;
            font-weight: 600;
            color: #AAAAAA;
            margin-bottom: 10px;
            line-height: 1.3;
            padding-right: 25px; /* Space for clear button */
        }


        /* Input & Output Lines */
        .input-line, .output-line {
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            gap: 6px;
            overflow-x: auto;
            padding-bottom: 5px;
            margin-bottom: -5px;
        }

        .output-line {
            margin-top: 10px;
        }

        /* Input Fields */
        .calculator-section input[type="number"] {
            width: 85px;
            flex-shrink: 0;
            padding: 8px 10px;
            border: 1px solid #2196f3;
            background-color: #2D2D2D;
            color: #EAEAEA;
            border-radius: 4px;
            font-size: 0.95em;
            appearance: textfield;
            -moz-appearance: textfield;
            transition: border-color 0.2s ease-in-out;
        }
        .calculator-section input[type=number]::-webkit-inner-spin-button,
        .calculator-section input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .calculator-section input[type="number"]:focus {
            outline: none;
            box-shadow: none;
            border-color: #F2A122; /* UPDATED ORANGE focus */
        }

        /* Readonly Output Fields */
        .calculator-section input[readonly] {
            background-color: #444;
            cursor: default;
            border-color: #555; /* Base border */
             flex-grow: 1;
             min-width: 50px;
             padding: 8px 10px;
             border-radius: 4px;
             font-size: 0.95em;
             color: #EAEAEA;
             border: 1px solid #555;
        }
        .calculator-section input[readonly]:focus {
            outline: none;
            box-shadow: none;
            border-color: #555; /* Keep border same as non-focused */
        }

        /* Select Dropdown Styling */
        .calculator-section select {
            padding: 6px 8px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            border: 1px solid #2196f3;
            background-color: #2D2D2D;
            color: #EAEAEA;
            border-radius: 4px;
            font-size: 0.95em;
            flex-shrink: 0;
            width: auto;
        }
         .calculator-section select:focus {
            outline: none;
            border-color: #F2A122; /* UPDATED ORANGE focus */
            box-shadow: none;
         }


        /* Labels and Text */
        .calculator-section span {
            font-size: 0.95em;
            color: #CFCFCF;
            flex-shrink: 0;
            white-space: nowrap;
        }

        /* Result Group (contains readonly input + %) */
        .result-group {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-grow: 1; /* Group takes available space */
             min-width: 70px;
        }
        .result-group input[readonly] {
             flex-grow: 1; /* Input takes space within group */
             width: auto;
             min-width: 50px;
        }
         .result-group span { /* The % sign */
             display: inline-block;
             width: auto;
             flex-shrink: 0;
        }

        /* Calculate Buttons */
        .calculator-section button:not(.clear-section-btn):not(.copy-btn) { /* Target CALC buttons specifically */
            padding: 9px 14px;
            background-color: #2196f3;
            color: #FFFFFF;
            border: none;
            border-radius: 4px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
            white-space: nowrap;
        }
        .calculator-section button:not(.clear-section-btn):not(.copy-btn):hover {
            background-color: #1976D2;
        }
        .calculator-section button:not(.clear-section-btn):not(.copy-btn):focus {
            outline: none;
            box-shadow: none;
        }

        /* Copy Button Styling */
        .copy-btn {
            background: none;
            border: none;
            padding: 0 5px; /* Minimal padding */
            margin-left: 4px; /* Small space after result field/group */
            cursor: pointer;
            color: #AAAAAA; /* Match clear button color */
            font-size: 1em; /* Adjust icon size if needed */
            line-height: 1;
            outline: none;
            box-shadow: none;
            flex-shrink: 0; /* Prevent shrinking */
            -webkit-tap-highlight-color: transparent;
        }
        .copy-btn i { /* Style the icon itself */
            display: block; /* Helps with alignment */
        }
        .copy-btn:focus,
        .copy-btn:active,
        .copy-btn:hover {
            outline: none !important;
            box-shadow: none !important;
            background: none !important;
            color: #CCCCCC !important; /* Optional: Slightly lighten on hover */
            border: none !important;
        }

        /* Settings & Layout Editor Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
        }

        .modal-content {
            background-color: #3A3A3A; /* Match section background */
            margin: 10% auto; /* Adjusted margin */
            padding: 25px;
            border: 1px solid #484848;
            border-radius: 6px;
            width: 90%; /* Wider on mobile */
            max-width: 500px; /* Adjusted max-width */
            position: relative;
            color: #EAEAEA;
        }

        .modal-close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            color: #AAAAAA;
            font-size: 1.8em;
            font-weight: bold;
            line-height: 1;
            background: none;
            border: none;
            padding: 0 5px;
            cursor: pointer;
            outline: none;
             box-shadow: none;
             -webkit-tap-highlight-color: transparent;
        }
        .modal-close-btn:hover,
        .modal-close-btn:focus {
            color: #FFFFFF;
            text-decoration: none;
            cursor: pointer;
             outline: none !important;
             box-shadow: none !important;
             background: none !important;
             border: none !important;
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.3em;
            color: #EAEAEA;
        }

        .setting-group {
            margin-bottom: 15px;
        }
        .setting-group > label { /* Target the main group label */
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #CFCFCF;
        }
        .radio-group {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .radio-group input[type="radio"] {
            margin-right: 8px;
             accent-color: #2196f3;
        }
         .radio-group label { /* Target label next to radio */
            margin-bottom: 0;
            font-weight: normal;
            color: #EAEAEA;
            cursor: pointer;
         }

         /* Layout Editor Specific Styles */
        hr.modal-divider {
            border: none;
            border-top: 1px solid #484848;
            margin: 20px 0;
        }
        button.modal-action-btn { /* Style for Edit Layout / Save Layout buttons */
             display: block;
             width: 100%;
             padding: 10px 15px;
             margin-top: 15px;
             background-color: #2196f3; /* Match main button */
             color: white;
             border: none;
             border-radius: 4px;
             font-size: 1em;
             cursor: pointer;
             transition: background-color 0.2s ease;
        }
        button.modal-action-btn:hover {
             background-color: #1976D2;
        }

        .modal-instructions {
            font-size: 0.9em;
            color: #AAAAAA;
            margin-bottom: 15px;
        }

        .layout-list {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0; /* Space before save button */
            border: 1px dashed #555; /* Add border around list */
            border-radius: 4px;
            max-height: 50vh; /* Limit height and allow scrolling */
            overflow-y: auto;
        }
        .layout-list li {
            background-color: #444;
            padding: 10px 12px;
            margin: 5px; /* Space items out slightly */
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: grab; /* Indicate draggable */
            border: 1px solid #555;
        }
        .layout-list li.dragging { /* Style when element is being dragged */
            opacity: 0.6;
            background-color: #505050;
            cursor: grabbing;
        }

        .drag-handle {
             color: #AAAAAA;
             cursor: grab;
             flex-shrink: 0;
             font-size: 1.1em;
        }
        .layout-title {
             flex-grow: 1; /* Take up space */
             font-size: 0.95em;
             overflow: hidden; /* Prevent text overflow */
             white-space: nowrap;
             text-overflow: ellipsis;
             pointer-events: none; /* Prevent title interfering with drag */
        }

        /* Simple Toggle Switch CSS */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px; /* Width of the switch */
            height: 20px; /* Height of the switch */
            flex-shrink: 0;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #666; /* Off state */
            transition: .3s;
            border-radius: 20px; /* Rounded */
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px; /* Size of the knob */
            width: 14px;
            left: 3px; /* Position of the knob */
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%; /* Circular knob */
        }
        input:checked + .slider {
            background-color: #2196f3; /* On state */
        }
        input:checked + .slider:before {
            transform: translateX(20px); /* Move knob to the right */
        }


        /* Larger Screens (Optional tweaks) */
        @media (min-width: 600px) {
             .modal-content {
                 margin: 10% auto; /* Less top margin */
                 width: 80%;
             }
        }

    </style>
</head>
<body>

    <div class="container" id="calculator-container">
        <header>
            <img src="icons/icon-192.png" alt="Logo" class="logo-img">
            <h1 data-translate-key="headerTitle">Calculator</h1>
             <button id="settings-btn" class="icon-btn" aria-label="Settings">
                <i class="fa-solid fa-gear"></i>
            </button>
        </header>

        <!-- Sections will be ordered by JS based on settings -->
        <!-- Calculator 1: What is X% of Y? -->
        <section id="calc-section-1" class="calculator-section" data-title-key="calc1Desc">
             <button class="clear-section-btn" aria-label="Clear this section">×</button>
             <h4 class="section-description" data-translate-key="calc1Desc">Find Percentage of Number</h4>
            <div class="input-line">
                <span data-translate-key="calc1Label1">What is</span>
                <input type="number" id="calc1-percent" step="any" aria-label="Percentage value">
                <span data-translate-key="calc1Label2">% of</span>
                <input type="number" id="calc1-base" step="any" aria-label="Base value">
            </div>
            <div class="output-line">
                <button id="calc1-btn" data-translate-key="calcButton">CALCULATE</button>
                <input type="text" id="calc1-result" readonly aria-label="Calculation result 1">
                <button class="copy-btn" id="copy-calc1-result" aria-label="Copy result 1" style="display: none;">
                    <i class="fa-regular fa-copy"></i>
                </button>
            </div>
        </section>

        <!-- Calculator 2: X is what percent of Y? -->
        <section id="calc-section-2" class="calculator-section" data-title-key="calc2Desc">
            <button class="clear-section-btn" aria-label="Clear this section">×</button>
             <h4 class="section-description" data-translate-key="calc2Desc">Find Part's Percentage of Whole</h4>
             <div class="input-line">
                <input type="number" id="calc2-part" step="any" aria-label="Part value">
                <span data-translate-key="calc2Label1">is what % of</span>
                <input type="number" id="calc2-whole" step="any" aria-label="Whole value">
            </div>
            <div class="output-line">
                 <button id="calc2-btn" data-translate-key="calcButton">CALCULATE</button>
                <div class="result-group">
                     <input type="text" id="calc2-result" readonly aria-label="Calculation result 2">
                     <span id="calc2-percent-symbol">%</span>
                </div>
                 <button class="copy-btn" id="copy-calc2-result" aria-label="Copy result 2" style="display: none;">
                    <i class="fa-regular fa-copy"></i>
                 </button>
            </div>
        </section>

        <!-- Calculator 3: Percentage Increase/Decrease from X to Y -->
        <section id="calc-section-3" class="calculator-section" data-title-key="calc3Desc">
             <button class="clear-section-btn" aria-label="Clear this section">×</button>
             <h4 class="section-description" data-translate-key="calc3Desc">Calculate Percentage Change</h4>
             <div class="input-line">
                <span data-translate-key="calc3Label1">% change</span>
                <span data-translate-key="calc3Label2">from</span>
                <input type="number" id="calc3-from" step="any" aria-label="Starting value">
                <span data-translate-key="calc3Label3">to</span>
                <input type="number" id="calc3-to" step="any" aria-label="Ending value">
            </div>
            <div class="output-line">
                 <button id="calc3-btn" data-translate-key="calcButton">CALCULATE</button>
                 <div class="result-group">
                    <input type="text" id="calc3-result" readonly aria-label="Calculation result 3">
                    <span id="calc3-percent-symbol">%</span>
                </div>
                  <button class="copy-btn" id="copy-calc3-result" aria-label="Copy result 3" style="display: none;">
                    <i class="fa-regular fa-copy"></i>
                 </button>
            </div>
        </section>

        <!-- Calculator 4: Increase/Decrease X by Y% -->
        <section id="calc-section-4" class="calculator-section" data-title-key="calc4Desc">
             <button class="clear-section-btn" aria-label="Clear this section">×</button>
             <h4 class="section-description" data-translate-key="calc4Desc">Value After % Increase/Decrease</h4>
             <div class="input-line">
                <select id="calc4-operation" aria-label="Operation Type">
                    <option value="increase" data-translate-key="increaseOpt">Increase</option>
                    <option value="decrease" data-translate-key="decreaseOpt">Decrease</option>
                </select>
                <input type="number" id="calc4-base" step="any" aria-label="Base value">
                <span data-translate-key="calc4Label1">by</span>
                <input type="number" id="calc4-percent" step="any" aria-label="Percentage value">
                 <span>%</span>
            </div>
            <div class="output-line">
                 <button id="calc4-btn" data-translate-key="calcButton">CALCULATE</button>
                 <input type="text" id="calc4-result" readonly aria-label="Calculation result 4">
                  <button class="copy-btn" id="copy-calc4-result" aria-label="Copy result 4" style="display: none;">
                    <i class="fa-regular fa-copy"></i>
                 </button>
            </div>
        </section>

        <!-- Calculator 5: Reverse Percentage (Find Original) -->
        <section id="calc-section-5" class="calculator-section" data-title-key="calc5Desc">
             <button class="clear-section-btn" aria-label="Clear this section">×</button>
             <h4 class="section-description" data-translate-key="calc5Desc">Find Original Value (Reverse %)</h4>
             <div class="input-line">
                <input type="number" id="calc5-final" step="any" aria-label="Final value">
                <span data-translate-key="calc5Label1">is</span>
                <input type="number" id="calc5-percent" step="any" aria-label="Percentage value">
                <span>%</span>
                 <select id="calc5-operation" aria-label="Operation Type">
                    <option value="more" data-translate-key="moreThanOpt">more than</option>
                    <option value="less" data-translate-key="lessThanOpt">less than</option>
                </select>
                 <span data-translate-key="calc5Label2">what?</span>
            </div>
            <div class="output-line">
                 <button id="calc5-btn" data-translate-key="calcButton">CALCULATE</button>
                 <input type="text" id="calc5-result" readonly aria-label="Calculation result 5 (Original Value)">
                 <button class="copy-btn" id="copy-calc5-result" aria-label="Copy result 5" style="display: none;">
                    <i class="fa-regular fa-copy"></i>
                 </button>
            </div>
        </section>
        <!-- End Calculator Sections -->

    </div> <!-- End .container -->

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <button id="close-settings-btn" class="modal-close-btn" aria-label="Close settings">×</button>
            <h2 data-translate-key="settingsTitle">Settings</h2>
            <div class="setting-group">
                <label data-translate-key="langLabel">Language:</label>
                <div class="radio-group">
                    <input type="radio" id="lang-en" name="language" value="en">
                    <label for="lang-en">English</label>
                </div>
                <div class="radio-group">
                    <input type="radio" id="lang-bg" name="language" value="bg">
                    <label for="lang-bg">Български</label>
                </div>
            </div>
            <hr class="modal-divider">
            <button id="edit-layout-btn" class="modal-action-btn" data-translate-key="editLayoutBtn">Edit Layout</button>
        </div>
    </div>
    <!-- End Settings Modal -->

    <!-- Layout Editor Modal -->
    <div id="layout-editor-modal" class="modal">
        <div class="modal-content">
             <button id="close-layout-editor-btn" class="modal-close-btn" aria-label="Close layout editor">×</button>
             <h2 data-translate-key="layoutEditorTitle">Edit Layout</h2>
             <p class="modal-instructions" data-translate-key="layoutInstructions">Drag to reorder. Toggle visibility.</p>
             <ul id="layout-editor-list" class="layout-list">
                 <!-- List items will be generated by JS -->
             </ul>
             <button id="save-layout-btn" class="modal-action-btn" data-translate-key="saveLayoutBtn">Save & Close</button>
        </div>
    </div>
    <!-- End Layout Editor Modal -->


    <!-- Calculator Logic Script -->
    <script>
        // --- Translation Data ---
        const translations = {
            en: {
                headerTitle: "Calculator",
                calc1Desc: "Find Percentage of Number",
                calc1Label1: "What is",
                calc1Label2: "% of",
                calc2Desc: "Find Part's Percentage of Whole",
                calc2Label1: "is what % of",
                calc3Desc: "Calculate Percentage Change",
                calc3Label1: "% change",
                calc3Label2: "from",
                calc3Label3: "to",
                calc4Desc: "Value After % Increase/Decrease",
                increaseOpt: "Increase",
                decreaseOpt: "Decrease",
                calc4Label1: "by",
                calc5Desc: "Find Original Value (Reverse %)",
                calc5Label1: "is",
                moreThanOpt: "more than",
                lessThanOpt: "less than",
                calc5Label2: "what?",
                calcButton: "CALCULATE",
                settingsTitle: "Settings",
                langLabel: "Language:",
                copyResultLabel: "Copy result",
                editLayoutBtn: "Edit Layout",
                layoutEditorTitle: "Edit Layout",
                layoutInstructions: "Drag to reorder. Toggle visibility.",
                saveLayoutBtn: "Save & Close"
            },
            bg: {
                headerTitle: "Калкулатор",
                calc1Desc: "Намиране на процент от число",
                calc1Label1: "Колко е",
                calc1Label2: "% от",
                calc2Desc: "Какъв процент е част от цяло",
                calc2Label1: "е какъв % от",
                calc3Desc: "Изчисляване на процентна промяна",
                calc3Label1: "% промяна",
                calc3Label2: "от",
                calc3Label3: "до",
                calc4Desc: "Стойност след % увеличение/намаление",
                increaseOpt: "Увеличение",
                decreaseOpt: "Намаление",
                calc4Label1: "с",
                calc5Desc: "Намиране на оригинална стойност (Обратно %)",
                calc5Label1: "е",
                moreThanOpt: "повече от",
                lessThanOpt: "по-малко от",
                calc5Label2: "колко?",
                calcButton: "ИЗЧИСЛИ",
                settingsTitle: "Настройки",
                langLabel: "Език:",
                copyResultLabel: "Копирай резултата",
                editLayoutBtn: "Редактиране на подредба",
                layoutEditorTitle: "Редактиране на подредба",
                layoutInstructions: "Плъзнете за пренареждане. Превключете видимост.",
                saveLayoutBtn: "Запази и Затвори"
            }
        };

        let currentLanguage = 'en'; // Default

        // --- Translation Function ---
        function setLanguage(lang) {
            if (!translations[lang]) { console.warn(`Language ${lang} not found.`); return; }
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            document.documentElement.lang = lang;

            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                if (translations[lang][key]) {
                     if (element.tagName === 'INPUT' && element.type === 'button') { element.value = translations[lang][key]; }
                     else if (element.tagName === 'BUTTON' || element.tagName === 'OPTION' || element.tagName === 'SPAN' || element.tagName === 'H1' || element.tagName === 'H4' || element.tagName === 'LABEL' || element.tagName === 'H2' || element.tagName === 'P') { element.textContent = translations[lang][key]; }
                } else { console.warn(`Translation key "${key}" not found for lang "${lang}".`); }
            });
             document.querySelectorAll('.copy-btn').forEach(btn => {
                 const baseId = btn.id.replace('copy-', '');
                 const resultNumber = baseId.match(/\d+/);
                 const newLabel = translations[lang]['copyResultLabel'] + (resultNumber ? " " + resultNumber[0] : "");
                 btn.setAttribute('aria-label', newLabel);
             });
            const radioToCheck = document.getElementById(`lang-${lang}`);
            if (radioToCheck) { radioToCheck.checked = true; }
             // Re-populate layout editor if it's open to update titles
             if(layoutEditorModal.style.display === 'block') {
                 populateLayoutEditor(currentLayoutSettings);
             }
        }

        // --- Layout Configuration ---
        const DEFAULT_LAYOUT = [
            { id: 'calc-section-1', visible: true },
            { id: 'calc-section-2', visible: true },
            { id: 'calc-section-3', visible: true },
            { id: 'calc-section-4', visible: true },
            { id: 'calc-section-5', visible: true }
        ];
        let currentLayoutSettings = []; // Will be loaded

        // --- Persistence Functions ---
        function saveLayoutSettings(settings) { try { localStorage.setItem('layoutSettings', JSON.stringify(settings)); } catch (e) { console.error("Failed to save layout settings:", e); } }
        function loadLayoutSettings() {
            const savedSettings = localStorage.getItem('layoutSettings');
            try {
                const parsed = savedSettings ? JSON.parse(savedSettings) : DEFAULT_LAYOUT.map(item => ({...item})); // Use deep copy of default
                 const currentIds = parsed.map(item => item.id);
                 const missing = DEFAULT_LAYOUT.filter(item => !currentIds.includes(item.id)).map(item => ({...item})); // Deep copy missing
                 currentLayoutSettings = [...parsed, ...missing];
                 const allDefaultIds = DEFAULT_LAYOUT.map(item => item.id);
                 currentLayoutSettings = currentLayoutSettings.filter(item => allDefaultIds.includes(item.id));
                 currentLayoutSettings.sort((a, b) => { const indexA = DEFAULT_LAYOUT.findIndex(item => item.id === a.id); const indexB = DEFAULT_LAYOUT.findIndex(item => item.id === b.id); return indexA - indexB; });
                 return currentLayoutSettings;
            } catch (e) { console.error("Failed to load or parse layout settings, using default:", e); currentLayoutSettings = DEFAULT_LAYOUT.map(item => ({...item})); return currentLayoutSettings; }
        }

        // --- Function to Apply Layout to Main Page ---
        function applyLayout(settings) {
            const container = document.getElementById('calculator-container');
            if (!container) return;
            settings.forEach(item => { const section = document.getElementById(item.id); if (section) { if (item.visible) { section.classList.remove('hidden-section'); } else { section.classList.add('hidden-section'); } } });
            settings.forEach(item => { if (item.visible) { const section = document.getElementById(item.id); if (section) { container.appendChild(section); } } });
        }

        // --- Layout Editor Variables ---
        const layoutEditorModal = document.getElementById('layout-editor-modal');
        const layoutEditorList = document.getElementById('layout-editor-list');
        const editLayoutBtn = document.getElementById('edit-layout-btn');
        const closeLayoutEditorBtn = document.getElementById('close-layout-editor-btn');
        const saveLayoutBtn = document.getElementById('save-layout-btn');
        let draggedItem = null;

        // --- Populate Layout Editor ---
        function populateLayoutEditor(settings) {
            if (!layoutEditorList) return;
            layoutEditorList.innerHTML = '';
            settings.forEach((item, index) => {
                const sectionElement = document.getElementById(item.id);
                const titleKey = sectionElement?.getAttribute('data-title-key') || item.id;
                const titleText = translations[currentLanguage]?.[titleKey] || item.id;
                const listItem = document.createElement('li');
                listItem.setAttribute('draggable', true);
                listItem.dataset.id = item.id; listItem.dataset.index = index;
                const handle = document.createElement('span'); handle.className = 'drag-handle'; handle.innerHTML = '<i class="fa-solid fa-grip-vertical"></i>';
                const title = document.createElement('span'); title.className = 'layout-title'; title.textContent = titleText; title.dataset.translateKey = titleKey;
                const toggleLabel = document.createElement('label'); toggleLabel.className = 'toggle-switch';
                const toggleInput = document.createElement('input'); toggleInput.type = 'checkbox'; toggleInput.checked = item.visible; toggleInput.dataset.id = item.id; toggleInput.addEventListener('change', handleVisibilityToggle);
                const slider = document.createElement('span'); slider.className = 'slider';
                toggleLabel.appendChild(toggleInput); toggleLabel.appendChild(slider);
                listItem.appendChild(handle); listItem.appendChild(title); listItem.appendChild(toggleLabel);
                listItem.addEventListener('dragstart', dragStart); listItem.addEventListener('dragover', dragOver); listItem.addEventListener('drop', drop); listItem.addEventListener('dragend', dragEnd);
                layoutEditorList.appendChild(listItem);
            });
        }

        // --- Drag and Drop Handlers ---
        function dragStart(e) { draggedItem = this; setTimeout(() => this.classList.add('dragging'), 0); e.dataTransfer.effectAllowed = 'move'; }
        function dragEnd() { setTimeout(() => { if (draggedItem) draggedItem.classList.remove('dragging'); draggedItem = null; }, 0); }
        function dragOver(e) {
             e.preventDefault(); e.dataTransfer.dropEffect = 'move';
             const targetItem = e.target.closest('li');
             if (targetItem && targetItem !== draggedItem) {
                 const list = targetItem.parentNode;
                 const rect = targetItem.getBoundingClientRect(); const offsetY = e.clientY - rect.top;
                 if (offsetY > rect.height / 2) { list.insertBefore(draggedItem, targetItem.nextSibling); }
                 else { list.insertBefore(draggedItem, targetItem); }
                 updateListItemIndices(list);
             }
        }
        function drop(e) { e.preventDefault(); }
        function updateListItemIndices(list) { list.querySelectorAll('li').forEach((item, index) => { item.dataset.index = index; }); }

        // --- Visibility Toggle Handler ---
        function handleVisibilityToggle(event) {
             // Intentionally left blank - visibility state is read on save
             // We don't update currentLayoutSettings immediately here
        }

        // --- Modal Control Logic ---
        editLayoutBtn.addEventListener('click', () => {
            settingsModal.style.display = 'none';
            // Load FRESH settings from storage when opening editor
            const settingsToEdit = loadLayoutSettings();
            populateLayoutEditor(settingsToEdit);
            layoutEditorModal.style.display = 'block';
        });
        closeLayoutEditorBtn.addEventListener('click', () => { layoutEditorModal.style.display = 'none'; });
        saveLayoutBtn.addEventListener('click', () => {
             const updatedSettings = [];
             layoutEditorList.querySelectorAll('li').forEach(item => { const id = item.dataset.id; const checkbox = item.querySelector('input[type="checkbox"]'); updatedSettings.push({ id: id, visible: checkbox.checked }); });
             currentLayoutSettings = updatedSettings;
             saveLayoutSettings(currentLayoutSettings);
             applyLayout(currentLayoutSettings);
             layoutEditorModal.style.display = 'none';
             // Re-check clear button visibility based on new layout
             document.querySelectorAll('.calculator-section').forEach(section => { if (!section.classList.contains('hidden-section')) updateClearButtonVisibility(section); });

        });


       // Helper function to get float value or null if invalid/empty
        function getFloatValue(id) { const element = document.getElementById(id); if (!element || element.value.trim() === '') return null; const value = parseFloat(element.value); return isNaN(value) ? null : value; }
        // Helper function to display result or error
        function displayResult(id, value) { const element = document.getElementById(id); const copyBtnId = 'copy-' + id; const copyBtn = document.getElementById(copyBtnId); let showCopyBtn = false; if (element) { if (value === null || typeof value === 'undefined' || value === '') { element.value = ''; } else if (typeof value === 'string' && isNaN(parseFloat(value)) && value !== '0') { element.value = value; } else if (typeof value === 'number' || (typeof value === 'string' && !isNaN(parseFloat(value)))) { element.value = parseFloat(Number(value).toFixed(4)).toString(); showCopyBtn = true; } else { element.value = ''; } } if (copyBtn) { copyBtn.style.display = showCopyBtn ? 'inline-block' : 'none'; } }
        // Helper Function to Check Section Input State
        function checkSectionHasInput(sectionElement) { if (!sectionElement) return false; const numberInputs = sectionElement.querySelectorAll('.input-line input[type="number"]'); for (const input of numberInputs) { if (input.value.trim() !== '') return true; } const selectInputs = sectionElement.querySelectorAll('.input-line select'); for (const select of selectInputs) { if (select.selectedIndex !== 0) return true; } return false; }
        // Function to Update Clear Button Visibility
        function updateClearButtonVisibility(sectionElement) { if (!sectionElement) return; const clearButton = sectionElement.querySelector('.clear-section-btn'); if (clearButton) { clearButton.style.display = checkSectionHasInput(sectionElement) ? 'block' : 'none'; } }
        // --- Calculator Logic Functions ---
        function calculatePercentageOf(percent, base) { return (percent / 100) * base; }
        function calculateWhatPercent(part, whole) { if (whole === 0) return 'Cannot divide by zero'; return (part / whole) * 100; }
        function calculatePercentChange(fromValue, toValue) { if (fromValue === 0) return toValue === 0 ? 0 : 'Change from zero undefined'; const change = toValue - fromValue; return (change / Math.abs(fromValue)) * 100; }
        function calculateValueChange(operation, base, percent) { const numBase = Number(base); const numPercent = Number(percent); if (isNaN(numBase) || isNaN(numPercent)) return 'Invalid input'; const changeAmount = (numPercent / 100) * numBase; if (operation === 'increase') return numBase + changeAmount; else if (operation === 'decrease') return numBase - changeAmount; else return null; }
        function calculateReversePercentage(finalValue, percent, operation) { const numFinal = Number(finalValue); const numPercent = Number(percent); if (isNaN(numFinal) || isNaN(numPercent)) return 'Invalid input'; if (numPercent < 0) return 'Percentage cannot be negative'; let originalValue; const percentAsDecimal = numPercent / 100; if (operation === 'more') { if (1 + percentAsDecimal === 0) return 'Calculation error'; originalValue = numFinal / (1 + percentAsDecimal); } else if (operation === 'less') { if (percentAsDecimal >= 1) { if (numFinal === 0 && percentAsDecimal === 1) return 0; return 'Cannot be 100% or more less'; } if (1 - percentAsDecimal === 0) return 'Calculation error (div by zero)'; originalValue = numFinal / (1 - percentAsDecimal); } else { return null; } return originalValue; }


        // --- Event Listeners for Calculate Buttons ---
         document.getElementById('calc1-btn').addEventListener('click', function() { const percent = getFloatValue('calc1-percent'); const base = getFloatValue('calc1-base'); displayResult('calc1-result', ''); if(percent === null || base === null) return; displayResult('calc1-result', calculatePercentageOf(percent, base)); });
         document.getElementById('calc2-btn').addEventListener('click', function() { const part = getFloatValue('calc2-part'); const whole = getFloatValue('calc2-whole'); displayResult('calc2-result', ''); if(part === null || whole === null) return; displayResult('calc2-result', calculateWhatPercent(part, whole)); });
         document.getElementById('calc3-btn').addEventListener('click', function() { const fromValue = getFloatValue('calc3-from'); const toValue = getFloatValue('calc3-to'); displayResult('calc3-result', ''); if(fromValue === null || toValue === null) return; displayResult('calc3-result', calculatePercentChange(fromValue, toValue)); });
         document.getElementById('calc4-btn').addEventListener('click', function() { const operation = document.getElementById('calc4-operation').value; const base = getFloatValue('calc4-base'); const percent = getFloatValue('calc4-percent'); displayResult('calc4-result', ''); if (base === null || percent === null) return; const result = calculateValueChange(operation, base, percent); displayResult('calc4-result', result); });
         document.getElementById('calc5-btn').addEventListener('click', function() { const finalValue = getFloatValue('calc5-final'); const percent = getFloatValue('calc5-percent'); const operation = document.getElementById('calc5-operation').value; displayResult('calc5-result', ''); if (finalValue === null || percent === null) return; const result = calculateReversePercentage(finalValue, percent, operation); displayResult('calc5-result', result); });


        // --- Add Enter key functionality ---
         const sections = document.querySelectorAll('.calculator-section'); sections.forEach(section => { const inputs = section.querySelectorAll('.input-line input[type="number"]'); const button = section.querySelector('.output-line button:not(.clear-section-btn):not(.copy-btn)'); if(inputs.length > 0 && button){ inputs.forEach(input => { input.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); button.click(); } }); }); } });


         // --- Add Clear Button Functionality ---
          document.querySelectorAll('.clear-section-btn').forEach(button => { button.addEventListener('click', (event) => { const section = event.target.closest('.calculator-section'); if (section) { section.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => { input.value = ''; }); section.querySelectorAll('select').forEach(select => { select.selectedIndex = 0; }); section.querySelectorAll('.copy-btn').forEach(copyBtn => { copyBtn.style.display = 'none'; }); updateClearButtonVisibility(section); } }); });


        // --- Add Copy Button Functionality ---
         document.querySelectorAll('.copy-btn').forEach(button => { button.addEventListener('click', async (event) => { const btn = event.target.closest('.copy-btn'); const outputLine = btn.closest('.output-line'); if (!outputLine) return; const resultInput = outputLine.querySelector('input[readonly]'); if (resultInput && resultInput.value) { try { await navigator.clipboard.writeText(resultInput.value); const icon = btn.querySelector('i'); if (icon) { const originalIconClass = icon.className; icon.className = 'fa-solid fa-check'; setTimeout(() => { icon.className = originalIconClass; }, 1500); } console.log('Result copied!'); } catch (err) { console.error('Copy failed: ', err); } } }); });


         // --- Add Input/Change Listeners to Sections for Clear Button ---
          document.querySelectorAll('.calculator-section').forEach(section => { section.addEventListener('input', (event) => { if (event.target.matches('.input-line input[type="number"]')) { updateClearButtonVisibility(section); } }); section.addEventListener('change', (event) => { if (event.target.matches('.input-line select')) { updateClearButtonVisibility(section); } }); });

        // --- Section Activation/Deactivation Logic ---
        const allCalculatorSections = document.querySelectorAll('.calculator-section');
        function deactivateAllSections() { allCalculatorSections.forEach(sec => { sec.classList.remove('active-section'); }); }
        allCalculatorSections.forEach(section => { section.addEventListener('click', (event) => { // Only activate if clicking within the section but NOT on a button inside it
             if (!event.target.closest('button')) {
                 if (!section.classList.contains('active-section')) { deactivateAllSections(); section.classList.add('active-section'); }
             }
         }); });
        document.addEventListener('click', (event) => { const clickedInsideSection = event.target.closest('.calculator-section'); const clickedInsideSettings = event.target.closest('#settings-btn') || event.target.closest('#settings-modal') || event.target.closest('#layout-editor-modal'); if (!clickedInsideSection && !clickedInsideSettings) { deactivateAllSections(); } });


        // --- Settings Modal Logic (Main) ---
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const langRadios = document.querySelectorAll('input[name="language"]');

        settingsBtn.addEventListener('click', () => { settingsModal.style.display = 'block'; const currentLangRadio = document.getElementById(`lang-${currentLanguage}`); if(currentLangRadio) currentLangRadio.checked = true; });
        closeSettingsBtn.addEventListener('click', () => { settingsModal.style.display = 'none'; });
        window.addEventListener('click', (event) => { if (event.target == settingsModal) { settingsModal.style.display = 'none'; } }); // Close on outside click
        langRadios.forEach(radio => { radio.addEventListener('change', (event) => { if (event.target.checked) { setLanguage(event.target.value); } }); });


        // --- Initial Page Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('language');
            const initialLang = savedLang && translations[savedLang] ? savedLang : 'en';
            setLanguage(initialLang);
            const settings = loadLayoutSettings();
            applyLayout(settings);
            document.querySelectorAll('.calculator-section:not(.hidden-section)').forEach(section => {
                updateClearButtonVisibility(section);
            });
        });


    </script>

    <!-- PWA: Script to Register the Service Worker (Using Absolute Path) -->
     <script> if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/Percentage-Calc/service-worker.js') .then(registration => { console.log('SW registered: ', registration.scope); }) .catch(error => { console.error('SW registration failed: ', error); }); }); } </script>

</body>
</html>